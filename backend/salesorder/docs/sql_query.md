SELECT
    S."SlpName" AS "Satici",
    CASE WHEN T."SourceTable" = 'ORDR' THEN 'Satış Siparişi' ELSE 'Taslak' END AS "BelgeTur",
    LS1."Status" AS "Onay1Status",
    LS2."Status" AS "Onay2Status",
    TO_VARCHAR(T."TaxDate", 'YYYY-MM-DD') AS "BelgeTarihi",
    TO_VARCHAR(T."DocDueDate", 'YYYY-MM-DD') AS "TeslimTarihi",
    T."WddStatus" AS "BelgeStatus",
    T."CardCode" AS "MusteriKod",
    T."CardName" AS "MusteriAd",
    T."DocEntry" AS "BelgeGirisNo", 
    CASE WHEN T."SourceTable" = 'ORDR' THEN T."DocNum" ELSE T."DocEntry" END AS "SipNo",
    T."U_sales_type" AS "SatisTipi",
    T."Comments" AS "BelgeAciklamasi",
    T."Address2" AS "SevkAdresi" ,
    (CAST(T."DocEntry" AS VARCHAR) || CAST(R."LineNum" AS VARCHAR)) AS "UniqueMasterNo",
    OITM."ItmsGrpCod" AS "KalemGrupKod",
    OITB."ItmsGrpNam" AS "KalemGrup",
    OITM."U_eski_bilesen_kod" AS "EskiBilesenKod", 
    T."U_musteri_siparis_no" AS "MusteriSipNo", 
    TO_VARCHAR(T."U_musteri_siparis_tarihi", 'YYYY-MM-DD') AS "MusteriSipTarih",
    T."U_commission_no" AS "AssmannCommNo" ,
    R."U_pos_no" AS "AssmannPosNo",
    R."U_item_no" AS "AssmannItemNo",
    R."U_renk_kod" AS "RenkKod",
    R."U_uretim_aciklamasi" AS "UretimAciklamasi",
    R."LineStatus" AS "SatirStatus",
    R."LineNum" AS "SatirNo",
    R."WhsCode" AS "DepoKod",
    R."ItemCode" AS "KalemKod",
    R."Dscription" AS "KalemTanimi",
    R."UomCode" AS "Birim",
    R."Quantity" AS "SipMiktar",
    R."DelivrdQty" AS "SevkMiktar",
    R."OpenCreQty" AS "KalanMiktar",
    
    -- yabancı para birimi eur
    R."PriceBefDi" AS "ListeFiyatDPB",
    R."DiscPrcnt"  AS "IskontoOran",
    R."Price"      AS "NetFiyatDPB",
    (R."Quantity" * R."PriceBefDi") AS "BrutTutarDPB", 
    CASE WHEN R."Currency" = 'TRY' THEN R."LineTotal" ELSE R."TotalFrgn" END AS "NetTutarDPB",
    CASE WHEN R."Currency" = 'TRY' THEN ((R."Quantity" * R."PriceBefDi" * COALESCE(NULLIF(R."Rate", 0), 1)) * (R."DiscPrcnt" / 100)) ELSE ((R."Quantity" * R."PriceBefDi") - R."TotalFrgn") END AS "IskTutarDPB",
    CASE WHEN R."Currency" = 'TRY' THEN R."VatSum" ELSE R."VatSumFrgn" END AS "KdvTutarDPB",
    CASE WHEN R."Currency" = 'TRY' THEN R."GTotal" ELSE R."GTotalFC"   END AS "KdvliNetTutarDPB",
    R."Rate" AS "Kur",
    R."Currency" AS "Doviz",
    
 -- Yerel para birimi cinsinden hesaplamalar
   --- (R."Price" * R."Rate") AS "ListeFiyatYPB",
   (R."Price" * CASE WHEN R."Rate" = 0 THEN 1 ELSE R."Rate" END) AS "ListeFiyatYPB",
   --(R."Quantity" * R."PriceBefDi" * R."Rate") AS "BrutTutarYPB",
   (R."Quantity" * R."PriceBefDi" * COALESCE(NULLIF(R."Rate", 0), 1)) AS "BrutTutarYPB",
   -- ((R."Quantity" * R."PriceBefDi" * R."Rate") * (R."DiscPrcnt" / 100)) AS "IskTutarYPB",
   ((R."Quantity" * R."PriceBefDi" * COALESCE(NULLIF(R."Rate", 0), 1)) * (R."DiscPrcnt" / 100)) AS "IskTutarYPB",
    R."LineTotal" AS "NetTutarYPB",
    R."VatPrcnt" AS "KdvOran",
    R."VatSum" AS "KdvTutarYPB",  
    R."GTotal" AS "KdvliNetTutarYPB"
  

FROM
    (
        SELECT *, 'ORDR' AS "SourceTable" FROM "TUNADB24"."ORDR" WHERE "ObjType" = '17'
        UNION ALL
        SELECT *, 'ODRF' AS "SourceTable" FROM "TUNADB24"."ODRF" 
        WHERE "ObjType" = '17' AND "WddStatus" = 'W' -- Yalnızca "Beklemede" olan taslakları dahil et
    ) T
LEFT JOIN (
        SELECT * FROM "TUNADB24"."RDR1" 
        UNION ALL
        SELECT * FROM "TUNADB24"."DRF1"
    ) R ON T."DocEntry" = R."DocEntry"
LEFT JOIN "TUNADB24"."OSLP" S ON T."SlpCode" = S."SlpCode"
LEFT JOIN "TUNADB24"."OWDD" OWDD ON T."DocEntry" = OWDD."DocEntry"
LEFT JOIN "TUNADB24"."OITM" OITM ON R."ItemCode" = OITM."ItemCode"
LEFT JOIN "TUNADB24"."OITB" OITB ON OITB."ItmsGrpCod" = OITM."ItmsGrpCod"
LEFT JOIN (
    SELECT
        WDD1."WddCode",
        WDD1."Status",
        ROW_NUMBER() OVER (PARTITION BY WDD1."WddCode" ORDER BY WDD1."UpdateDate" DESC, WDD1."UpdateTime" DESC) AS rn
    FROM
        "TUNADB24"."WDD1"
    WHERE
        WDD1."StepCode" = 1
) LS1 ON OWDD."WddCode" = LS1."WddCode" AND LS1.rn = 1
LEFT JOIN (
    SELECT
        WDD1."WddCode",
        WDD1."Status",
        ROW_NUMBER() OVER (PARTITION BY WDD1."WddCode" ORDER BY WDD1."UpdateDate" DESC, WDD1."UpdateTime" DESC) AS rn
    FROM
        "TUNADB24"."WDD1"
    WHERE
        WDD1."StepCode" = 2
) LS2 ON OWDD."WddCode" = LS2."WddCode" AND LS2.rn = 1
WHERE --T."DocEntry" = 5286 and   -- T."DocEntry" = 5296
    --T."DocEntry" = {?DocKey@} AND
    --R."Currency" = 'TRY' AND
  -- S."SlpName" = 'Kaan Ezik' AND
    --T."SourceTable" != 'ORDR' AND
    T."DocDate" >= '2023-01-01' 
    AND T."CANCELED" = 'N'
    AND (OWDD."WddCode" IS NULL OR OWDD."WddCode" IN (
        SELECT MAX("WddCode")
        FROM "TUNADB24"."OWDD"
        WHERE "DocEntry" = T."DocEntry"
    ))AND T."DocEntry" NOT IN (2662,
2663,
2663,
2674,
2706,
2722,
2722,
2722,
2722,
2722,
2729,
2735,
2735,
2735,
2735,
2735,
2735,
2735,
2735,
2735,
2735,
2735,
2735,
2735,
2333,
2334,
2335,
2545,
3519,
2546,
2547,
2548,
2548,
2548,
2549,
2550,
2551,
2552,
2553,
2554,
2555,
2555,
2556,
2557,
2557,
3562,
3562,
3562,
3562,
2558,
2559,
2560,
2561,
2561,
2562,
2563,
2564,
2564,
2564,
2564,
2564,
2564,
2564,
2564,
2565,
2565,
2566,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2567,
2568,
2568,
2568,
2568,
2568,
2568,
2569,
2570,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2571,
2572,
2573,
2574,
2575,
2575,
2575,
2575,
2575,
2575,
3563,
3563,
3563,
2576,
2576,
2577,
2578,
3564,
3564,
3564,
3564,
2579,
2579,
2579,
3565,
3566,
2580,
2581,
2582,
2583,
2584,
2584,
2585,
2585,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2586,
2587,
2587,
2587,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2588,
2589,
2590,
2590,
2591,
2591,
2591,
3567,
3567,
3567,
3567,
3568,
3568,
3568,
3568,
3568,
3568,
3568,
3568,
3568,
3568,
3568,
2592,
2592,
2592,
2592,
2592,
2592,
2592,
2593,
2593,
2593,
2593,
2593,
2593,
2593,
2594,
2594,
2594,
2594,
2594,
2595,
2595,
2595,
2595,
2595,
2596,
2596,
2596,
2596,
2596,
2596,
2596,
2596,
2596,
2596,
2596,
2596,
2597,
2598,
2598,
2598,
2599,
2599,
2599,
2599,
2599,
2599,
2599,
2600,
2601,
2602,
2603,
2604,
2605,
3569,
3569,
3569,
2606,
2606,
2606,
2606,
2606,
2606,
2606,
2606,
2606,
2607,
2608,
2608,
2609,
2610,
2611,
2611,
2612,
2613,
2614,
2615,
2615,
2616,
2616,
2616,
2616,
2617,
2618,
2618,
2618,
2618,
2618,
2618,
2618,
2618,
2618,
2619,
2619,
2619,
2619,
2619,
2619,
2619,
2619,
2619,
2620,
2621,
2622,
2623,
2624,
2625,
2626,
2664,
3570,
3570,
3571,
2627,
2627,
2627,
2627,
2627,
2627,
2627,
2627,
2627,
2627,
2627,
2627,
3572,
3572,
3572,
3572,
2628,
2629,
2630,
2631,
2632,
2633,
2633,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2634,
2635,
2636,
2637,
2637,
2637,
2637,
2637,
2637,
2637,
2638,
2639,
2639,
2640,
3573,
3573,
3573,
3573,
2641,
2642,
2643,
2644,
2644,
2644,
2645,
2645,
2646,
2646,
2647,
2648,
2648,
2649,
2649,
2650,
2651,
2652,
2652,
2652,
2652,
2652,
2652,
2652,
2652,
2653,
2653,
2653,
2653,
2653,
2653,
2653,
2653,
2653,
2653,
2653,
2654,
2654,
2654,
2654,
2654,
2654,
2654,
2655,
2655,
2655,
2655,
2655,
2655,
3574,
3574,
3574,
3574,
3574,
2656,
2656,
2656,
2656,
3575,
3575,
3575,
3575,
3575,
3575,
3575,
3575,
3575,
3575,
3575,
3575,
3575,
2657,
2658,
2659,
2660,
2661,
2665,
2666,
2667,
2668,
2669,
2669,
2669,
2669,
2669,
2669,
2669,
2669,
2669,
2669,
2669,
2669,
2670,
2671,
2672,
2673,
2673,
2673,
2673,
2673,
2673,
2673,
2673,
2673,
2673,
3576,
3576,
3576,
3576,
2675,
2676,
2677,
2678,
2679,
2680,
2681,
2682,
2683,
2684,
2685,
2686,
2687,
2687,
2688,
2688,
2689,
2690,
2691,
2692,
2693,
2694,
2695,
2695,
2695,
2696,
2697,
2698,
2698,
2698,
2698,
2698,
2698,
2698,
2698,
2698,
2698,
2698,
2698,
2698,
2699,
2699,
2699,
2699,
2699,
2699,
2699,
2700,
2700,
2700,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2701,
2702,
2703,
2704,
2704,
2704,
2704,
2704,
2704,
2704,
2704,
2704,
2704,
2704,
2704,
2705,
2705,
2705,
2705,
2705,
2705,
2705,
2705,
2705,
2705,
2707,
2708,
2708,
2709,
2709,
2709,
2710,
2711,
2712,
2713,
2713,
2714,
2715,
2716,
2717,
2718,
3577,
3577,
3577,
3577,
3578,
3578,
3578,
3578,
3578,
2719,
2719,
2719,
2720,
2720,
2720,
2721,
2723,
2724,
2725,
2726,
2728,
2728,
3579,
2730,
2730,
2730,
3580,
3580,
2731,
2732,
2732,
2732,
2732,
2732,
2732,
2732,
2732,
2733,
2733,
2733,
2734,
2736,
2736,
2736,
2736,
2737,
2737,
2737,
2737,
2737,
2737,
2737,
2737,
2737,
2737,
2738,
2739,
2740,
2741,
2741,
2741,
2741,
2741,
2741,
2741,
2741,
2741,
2742,
2742,
2742,
2742,
2742,
2743,
2743,
2743,
2743,
2743,
2743,
2743,
2743,
2744,
2745,
2746,
2746,
2747,
2747,
2747,
2748,
2748,
2749,
2750,
2750,
2750,
2751,
2752,
2752,
2753,
2753,
2754,
2754,
2754,
2754,
2754,
2754,
2754,
2754,
2754,
2754,
2754,
2754,
2754,
2755,
2755,
2755,
2755,
2755,
2756,
2756,
2756,
2756,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2757,
2758,
2759,
2760) -- NumAtCard IRT HMD VE IHR ile başlayan irsaliye 2023 den gelen belgeler hariç tutuldu 